
name: Publish Quanty Docker image to GitHub Packages

on:
  push:
  release:
    types: [published]

permissions:
  contents: read
  packages: write
  attestations: write
  id-token: write

env:
  REGISTRY: ghcr.io
  # This sets the repo namespace; the image name will be ghcr.io/<repo>/quanty
  IMAGE_BASE: ${{ github.repository }}
  DOCKER_BUILDKIT: '1'
  COMPOSE_DOCKER_CLI_BUILD: '1'

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install helpers
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      # --- Authenticated download of Quanty Linux ZIP ---
      # Rationale:
      #  - Quanty's Download area shows platform links only after login. [1](https://www.quanty.org/download)
      #  - The site runs DokuWiki; passing `u` and `p` triggers login and sets a cookie. [2](https://www.dokuwiki.org/devel:authentication)
      #  - We download outside the Docker build to avoid embedding credentials in the image.
      - name: Download Quanty (Linux ZIP)
        working-directory: images/quanty
        env:
          Q_USER: ${{ secrets.QUANTY_USERNAME }}
          Q_PASS: ${{ secrets.QUANTY_PASSWORD }}
        run: |
          set -euo pipefail

          # 1) Login to DokuWiki (creates session cookie)
          curl -sS -c quanty_cookies.txt \
            "https://www.quanty.org/doku.php?id=download&u=${Q_USER}&p=${Q_PASS}&r=1" \
            -o /dev/null

          # 2) Fetch the Download area (links now visible because we're authenticated)
          curl -sS -b quanty_cookies.txt -L "https://www.quanty.org/download" -o download.html

          URL=$(
            awk '
              BEGIN{ IGNORECASE=1; RS="</a>"; ORS="" }
              /Download[[:space:]]+Quanty[[:space:]]+for[[:space:]]+Linux/ {
                if (match($0, /href="([^"]+)"/, m)) { print m[1]; exit }
              }
            ' download.html
          )
          
          if [ -z "${URL}" ]; then
           echo "Could not locate the Linux download link on the page."
           exit 1
          fi
          echo "Resolved Linux URL: ${URL}"
          
          BASE="https://www.quanty.org"
          if [[ "$URL" =~ ^/ ]]; then
            URL="${BASE}${URL}"
          fi
          echo "Linux download URL: $URL"

          # 4) Download the ZIP (this ZIP contains a single executable named 'Quanty')
          curl -L -b quanty_cookies.txt -o quanty-linux.zip "${URL}"

          # Sanity info (no secrets)
          file quanty-linux.zip || true
          ls -l quanty-linux.zip

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3.5.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # We want this repo to publish multiple images; this job is for "quanty".
      # metadata-action will generate tags/labels based on the release ref.
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5.8.0
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/quanty
          # On a release event, this includes the release tag (e.g., v1.2.3).
          # Add 'latest' for releases as well:
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      # Build and push with the Quanty ZIP passed as a BuildKit secret:
      #  - Keeps the vendor ZIP out of the build context, layers, and caches.
      #  - Only the final executable is installed into the image (cleaner SBOM).
      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v6.18.0
        with:
          context: images/quanty
          file: images/quanty/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Inject the downloaded ZIP without persisting it into layers
          secrets: |
            "quanty_zip=images/quanty/quanty-linux.zip"

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/quanty
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true
